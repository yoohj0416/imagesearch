<!doctype html>
<html>
<head>
  <title>User Study – Video Search Task</title>
  <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js" crossorigin="anonymous"></script>
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js" crossorigin="anonymous"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h1 { text-align: center; }
    #header { text-align: center; margin-bottom: 20px; font-size: 18px; }
    /* 텍스트가 내용만큼의 너비를 갖도록 수정 */
    #header #currentTask { margin-bottom: 5px; display: inline-block; }
    #stage-topic { font-size: 16px; display: block; }
    #searchContainer { text-align: center; margin-bottom: 20px; }
    #searchBox { width: 500px; padding: 8px; font-size: 16px; }
    #btnSearch { padding: 8px 16px; font-size: 16px; }
    #videoList {
      width: 100%;
      max-width: 1600px;
      margin: 20px auto;
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
    }
    .video-container {
      flex: 0 0 calc(20% - 20px);
      margin: 10px;
      text-align: center;
    }
    .video-container img,
    .video-container video {
      width: 100%;
      display: block;
      margin: auto;
    }
    .select-button {
      margin-top: 5px;
      padding: 5px 10px;
      font-size: 14px;
      cursor: pointer;
    }
    /* Tooltip */
    .demo-tooltip {
      position: absolute;
      background: #fff;
      border: 1px solid #ccc;
      padding: 10px 10px 40px;
      border-radius: 5px;
      box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
      z-index: 1001;
      max-width: 250px;
    }
    #tooltipNext {
      position: absolute;
      bottom: 5px;
      right: 5px;
    }
    /* Overlays */
    .overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.7);
      z-index: 1002;
      display: none;
      color: #fff;
      font-size: 20px;
      text-align: center;
      padding-top: 20%;
    }
    #welcomeOverlay button,
    #finalOverlay button {
      margin-top: 20px;
      padding: 10px 20px;
      font-size: 18px;
      background: #fff;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    #finalOverlay div { display: inline-block; }
    #finalOverlay button { margin: 0 10px; }
  </style>
  <script>
    // Basic Task/Stage/Topic
    var currentDataset = "drama";
    var currentStage = "without autocompletion";
    var currentTopic = "pedestrian";
    function getTaskLabel() {
      if (currentDataset === "drama") {
        return "<strong>Driving Scene Video Search</strong>";
      } else {
        return "<strong>Online Video Search</strong>";
      }
    }
    function updateUI() {
      $("#currentTask").html("Task: " + getTaskLabel());
      $("#currentStage").html("Stage: <strong>" + currentStage + "</strong>");
      $("#currentTopic").html("Topic: <strong>" + currentTopic + "</strong>");
    }

    $(function() {
      updateUI(); 

      // Demo Steps
      var demoState = {
        currentStep: 0,
        steps: [
          {
            element: "#header",
            text: "This area displays the current Task, Stage, and Topic.",
            event: "click"
          },
          {
            element: "#searchBox",
            text: "Enter a query with at least 3 words.",
            event: "input",
            condition: function() {
              return $("#searchBox").val().trim().split(/\s+/).length >= 5;
            }
          },
          {
            element: "#btnSearch",
            text: "Click here to display the relevant videos.",
            event: "click"
          },
          {
            element: "#videoList .video-container:first-child img, #videoList .video-container:first-child video",
            text: "Click a thumbnail to load and play the video.",
            event: "click"
          },
          {
            element: "#videoList .video-container:first-child .select-button",
            text: "Click Select if it's relevant to proceed.",
            event: "click"
          }
        ]
      };

      function showWelcomeOverlay() {
        $("#welcomeOverlay").fadeIn();
      }
      function showFinalOverlay() {
        $("#finalOverlay").fadeIn();
      }

      function showTooltip(step) {
        $(".demo-tooltip").remove();
        var $target = $(step.element);
        if (!$target.length) {
          nextDemoStep();
          return;
        }
        var tooltip = $("<div class='demo-tooltip'></div>");
        var textDiv = $("<div class='tooltip-text'></div>").html(step.text);
        var nextButton = $("<button id='tooltipNext'>Next</button>");
        tooltip.append(textDiv).append(nextButton);
        $("body").append(tooltip);

        if (step.element === "#header") {
          // #currentTask가 inline-block으로 되어 있어, 실제 텍스트 너비만큼만 공간을 차지하게 됨.
          var $textElem = $("#currentTask");
          var textOffset = $textElem.offset();
          var desiredLeft = textOffset.left + $textElem.outerWidth();  // 텍스트 바로 옆에 위치
          var tooltipWidth = tooltip.outerWidth();
          var windowWidth = $(window).width();
          if (desiredLeft + tooltipWidth > windowWidth) {
            desiredLeft = windowWidth - tooltipWidth;
          }
          tooltip.css({
            top: textOffset.top,
            left: desiredLeft
          });
        } else if (step.element === "#searchBox") {
          var offset = $target.offset();
          tooltip.css({
            top: offset.top + $target.outerHeight() + 10,
            left: offset.left
          });
        } else {
          var offset = $target.offset();
          tooltip.css({
            top: offset.top,
            left: offset.left + $target.outerWidth() + 10
          });
        }

        nextButton.on("click", function(e) {
          e.stopPropagation();
          if (step.element === "#searchBox") {
            $("#searchBox").val("a man unloading a truck near a busy intersection");
          } else if (step.element === "#btnSearch") {
            populateVideoList();
          }
          nextDemoStep();
        });
        
        // event-based step
        if (step.event === "input") {
          $target.on("input.demo", function() {
            if (step.condition && step.condition()) {
              $target.off("input.demo");
              nextDemoStep();
            }
          });
        } else if (step.event === "click") {
          $target.one("click.demo", function() {
            nextDemoStep();
          });
        }
      }

      function nextDemoStep() {
        demoState.currentStep++;
        $(".demo-tooltip").remove();
        if (demoState.currentStep < demoState.steps.length) {
          showTooltip(demoState.steps[demoState.currentStep]);
        } else {
          showFinalOverlay();
        }
      }

      function populateVideoList() {
        var videos = [
          "2020-0127-132751-002348.mp4",
          "2020-0127-132751-003557.mp4",
          "2020-0127-132751-003604.mp4",
          "2020-0127-132751-009980.mp4",
          "2020-0127-132751-018400.mp4"
        ];
        var container = $("#videoList");
        container.empty();
        videos.forEach(function(file) {
          var videoSrc = "static/drama-1k-vids/" + file;
          var thumb = "static/drama-1k-imgs/" + file.replace(".mp4", ".jpg");
          var videoDiv = $("<div class='video-container'></div>");
          var img = $("<img>")
            .attr("src", thumb)
            .css({ cursor: "pointer" })
            .on("click", function() {
              var videoElem = $("<video></video>")
                .attr({ src: videoSrc, controls: true })
                .css({ width: "320px", height: "180px" });
              $(this).replaceWith(videoElem);
              videoElem.get(0).play();
            });
          var selectBtn = $("<button class='select-button'>Select</button>");
          videoDiv.append(img).append(selectBtn);
          container.append(videoDiv);
        });
      }

      // Overlay button events
      $("#welcomeStartDemoButton").on("click", function() {
        $("#welcomeOverlay").fadeOut(function() {
          demoState.currentStep = 0;
          // 첫 번째 툴팁 표시
          showTooltip(demoState.steps[demoState.currentStep]);
        });
      });
      $("#retryDemoButton").on("click", function() {
        $("#finalOverlay").fadeOut(function(){
          demoState.currentStep = 0;
          showTooltip(demoState.steps[demoState.currentStep]);
        });
      });
      $("#startTestButton").on("click", function() {
        window.location.href = "emoji_autocomplete";
      });

      // Simple autocomplete example
      $("#searchBox").autocomplete({
        source: function(request, response) {
          $.ajax({
            url: "/search",
            dataType: "json",
            cache: false,
            data: { term: request.term },
            success: function(data){ response(data); },
            error: function(){}
          });
        },
        minLength: 2
      });

      // Display Welcome Overlay on page load
      showWelcomeOverlay();
    });
  </script>
</head>
<body>
  <h1>User Study: Video Search Task</h1>
  <div id="header">
    <div id="currentTask"></div>
    <div id="stage-topic">
      <span id="currentStage"></span> | <span id="currentTopic"></span>
    </div>
  </div>

  <!-- Welcome Overlay -->
  <div id="welcomeOverlay" class="overlay">
    <div>
      <p>Welcome to the demo. Before starting the user study, we will guide you through the main elements of this page so you can become familiar with its functionality.</p>
      <button id="welcomeStartDemoButton">Start Demo</button>
    </div>
  </div>

  <!-- Final Overlay -->
  <div id="finalOverlay" class="overlay">
    <div>
      <p>Demo complete. What would you like to do next?</p>
      <button id="retryDemoButton">Retry Demo</button>
      <button id="startTestButton">Start Test</button>
    </div>
  </div>

  <div id="searchContainer">
    <div style="display:flex; justify-content:center; width:100%;">
      <input type="text" name="search" id="searchBox" placeholder="Enter search query..." />
      <button type="button" id="btnSearch">Search</button>
    </div>
  </div>

  <div id="videoList"></div>
</body>
</html>
